From 7507127287aa8cf84b5e811977d95400b029f95b Mon Sep 17 00:00:00 2001
From: isimobile <isimobile@ismaakit.com>
Date: Wed, 11 Jan 2012 21:34:47 +0200
Subject: [PATCH] Added support for use of Honeycomb Radio (Modem) for
 GT-P7100 (p3).

Change-Id: I3a3474245bb336bc3f275605648f5f94f3f9b6e7
---
 .../android/internal/telephony/DataConnection.java |   17 ++++-
 .../java/com/android/internal/telephony/RIL.java   |    7 ++-
 .../com/android/internal/telephony/SamsungRIL.java |   74 ++++++++++++++++++++
 3 files changed, 95 insertions(+), 3 deletions(-)
 create mode 100644 telephony/java/com/android/internal/telephony/SamsungRIL.java

diff --git a/telephony/java/com/android/internal/telephony/DataConnection.java b/telephony/java/com/android/internal/telephony/DataConnection.java
index 4619899..6b9c05a 100644
--- a/telephony/java/com/android/internal/telephony/DataConnection.java
+++ b/telephony/java/com/android/internal/telephony/DataConnection.java
@@ -329,13 +329,28 @@ public abstract class DataConnection extends StateMachine {
         }
         if (DBG) log("NotifyDisconnectCompleted DisconnectParams=" + dp);
     }
+    
+    protected boolean needsOldRilFeature(String feature) {
+        String[] features = SystemProperties.get("ro.telephony.ril.v3", "").split(",");
+        for (String found: features) {
+            if (found.equals(feature))
+                return true;
+        }
+        return false;
+    }
 
     protected int getRadioTechnology(int defaultRadioTechnology) {
         int radioTechnology;
         if (mRilVersion < 6) {
             radioTechnology = defaultRadioTechnology;
         } else {
-            radioTechnology = phone.getServiceState().getRadioTechnology() + 2;
+        	if (needsOldRilFeature("usehcradio") ) {
+               radioTechnology = phone.getServiceState().getRadioTechnology() - 2;
+               if (radioTechnology != 1) // in reality if it is not 1 something is wrong for hc ??
+            	   radioTechnology = 1;
+        	}
+        	else
+        	   radioTechnology = phone.getServiceState().getRadioTechnology() + 2; // orginal code
         }
         return radioTechnology;
     }
diff --git a/telephony/java/com/android/internal/telephony/RIL.java b/telephony/java/com/android/internal/telephony/RIL.java
index 529724b..933f393 100644
--- a/telephony/java/com/android/internal/telephony/RIL.java
+++ b/telephony/java/com/android/internal/telephony/RIL.java
@@ -2966,7 +2966,7 @@ public class RIL extends BaseCommands implements CommandsInterface {
         return new IccIoResult(sw1, sw2, s);
     }
 
-    private boolean needsOldRilFeature(String feature) {
+    protected boolean needsOldRilFeature(String feature) {
         String[] features = SystemProperties.get("ro.telephony.ril.v3", "").split(",");
         for (String found: features) {
             if (found.equals(feature))
@@ -3094,7 +3094,10 @@ public class RIL extends BaseCommands implements CommandsInterface {
             dataCall.ifname = Resources.getSystem().getString(com.android.internal.R.string.config_datause_iface);
         } else {
             dataCall.status = p.readInt();
-            dataCall.suggestedRetryTime = p.readInt();
+            if (needsOldRilFeature("usehcradio")) 
+                dataCall.suggestedRetryTime = -1;
+            else
+            	dataCall.suggestedRetryTime = p.readInt();	            
             dataCall.cid = p.readInt();
             dataCall.active = p.readInt();
             dataCall.type = p.readString();
diff --git a/telephony/java/com/android/internal/telephony/SamsungRIL.java b/telephony/java/com/android/internal/telephony/SamsungRIL.java
new file mode 100644
index 0000000..0b7b9a8
--- /dev/null
+++ b/telephony/java/com/android/internal/telephony/SamsungRIL.java
@@ -0,0 +1,74 @@
+package com.android.internal.telephony;
+
+import java.util.ArrayList;
+import java.util.Collections;
+
+import android.content.BroadcastReceiver;
+import android.content.Context;
+import android.content.Intent;
+import android.content.IntentFilter;
+import android.net.ConnectivityManager;
+import android.os.Handler;
+import android.os.Message;
+import android.os.AsyncResult;
+import android.os.Parcel;
+import android.os.SystemProperties;
+import android.telephony.PhoneNumberUtils;
+import android.telephony.SmsMessage;
+import android.telephony.TelephonyManager;
+import static com.android.internal.telephony.RILConstants.*;
+
+import com.android.internal.telephony.IccUtils;
+import com.android.internal.telephony.RILConstants;
+import com.android.internal.telephony.CommandsInterface.RadioState;
+import com.android.internal.telephony.cdma.CdmaInformationRecords;
+
+import android.util.Log;
+
+public class SamsungRIL extends RIL implements CommandsInterface {
+
+	private boolean mSignalbarCount = SystemProperties.getInt("ro.telephony.sends_barcount", 0) == 1 ? true : false;
+
+	private boolean mIsSamsungCdma = SystemProperties.getBoolean("ro.ril.samsung_cdma", false);
+
+public SamsungRIL(Context context, int networkMode, int cdmaSubscription) {
+	super(context, networkMode, cdmaSubscription);
+}
+
+	@Override
+    protected Object
+    responseSignalStrength(Parcel p) {
+        int numInts = 12;
+        int response[];
+
+        boolean oldRil = needsOldRilFeature("signalstrength");
+
+        /* TODO: Add SignalStrength class to match RIL_SignalStrength */
+        response = new int[numInts];
+        for (int i = 0 ; i < numInts ; i++) {
+            if (oldRil && i > 6 && i < 12) {
+                response[i] = -1;
+            } else {
+                response[i] = p.readInt();
+            }
+        }
+        
+		if(mSignalbarCount)
+		{
+			//Samsung sends the count of bars that should be displayed instead of
+			//a real signal strength
+			response[0] = ((response[0] & 0xFF00) >> 8) * 3; //gsmDbm
+		} else {
+			response[0] = response[0] & 0xFF; //gsmDbm
+		}
+		response[1] = -1; //gsmEcio
+		response[2] = (response[2] < 0)?-120:-response[2]; //cdmaDbm
+		response[3] = (response[3] < 0)?-160:-response[3]; //cdmaEcio
+		response[4] = (response[4] < 0)?-120:-response[4]; //evdoRssi
+		response[5] = (response[5] < 0)?-1:-response[5]; //evdoEcio
+
+
+        return response;
+	}
+		
+}
-- 
1.7.5.4

